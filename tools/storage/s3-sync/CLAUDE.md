# S3 Sync Tool

## 功能描述
S3 Sync Tool 是一个高性能的 S3 存储桶同步工具，支持在不同的 AWS 环境之间同步 S3 存储桶。该工具具有并行处理、连接缓存、重试机制和交互式操作界面等高级功能。

### 核心特性
- **多环境支持**: 支持 AWS 标准环境和自定义 S3 兼容服务
- **并行同步**: 使用多线程技术提高同步效率
- **连接管理**: 支持连接配置的缓存和复用
- **智能重试**: 自动重试失败的对象传输
- **交互界面**: 基于 OpsKit 交互式组件的用户友好界面
- **安全存储**: 连接凭证采用 Base64 编码存储
- **权限友好**: 连接测试不需要 ListAllMyBuckets 权限
- **手动输入**: 支持在无法列出存储桶时手动输入存储桶名称

## 技术架构
- **实现语言**: Python 3.7+
- **核心依赖**: boto3, botocore
- **系统要求**: 无特殊系统依赖
- **OpsKit 集成**: 完整集成 OpsKit 框架的日志、存储和交互式组件

## 配置项

### 环境变量配置
工具支持以下环境变量配置：

```bash
# 并发配置
MAX_WORKERS=10                    # 最大并发工作线程数 (默认: 10)

# 重试配置  
MAX_RETRIES=5                     # 最大重试次数 (默认: 5)
RETRY_DELAY=2                     # 重试延迟基数，秒 (默认: 2)

# 功能开关
CACHE_CONNECTIONS=true            # 是否缓存连接配置 (默认: true)
CONFIRM_DESTRUCTIVE=true          # 是否确认破坏性操作 (默认: true)
```

### 连接配置
工具支持两种连接方式：

**1. AWS 默认配置**
- 使用 AWS CLI 或 SDK 的默认凭证链
- 适用于 IAM 角色、环境变量或共享凭证文件

**2. 自定义连接**
- 手动输入 AWS Access Key 和 Secret Key
- 支持自定义区域和 S3 兼容端点
- 连接配置可保存到临时目录供复用

## 开发指南

### 代码结构说明
```python
class S3SyncTool:
    def __init__(self):
        # 工具初始化和配置加载
    
    def _load_connections(self) -> Dict:
        # 加载已保存的连接配置
    
    def _input_connection_details(self, connection_type: str) -> Dict:
        # 交互式连接配置输入
    
    def _get_s3_client(self, connection_details: Dict) -> boto3.client:
        # 创建 S3 客户端
    
    def list_buckets(self, connection_details: Dict) -> List[str]:
        # 列出可用的存储桶
    
    def _copy_object(self, ...):
        # 单个对象复制（支持重试）
    
    def sync_buckets(self, ...):
        # 存储桶同步主逻辑（并行处理）
    
    def run(self):
        # 主执行流程
```

### 关键功能实现

**1. 连接管理**
- 使用 OpsKit 存储系统缓存连接配置
- 支持连接验证和自动重连
- 凭证安全处理（Base64 编码）

**2. 并行同步**
- 使用 `concurrent.futures.ThreadPoolExecutor` 实现并行上传
- 可配置的工作线程数量
- 实时进度跟踪和状态报告

**3. 权限适配和错误处理**
- 智能连接测试：优先使用 STS，回退到 head_bucket 测试
- 存储桶列表失败时支持手动输入存储桶名称
- 指数退避算法的自动重试机制
- 详细的错误日志记录和优雅的异常处理

**4. OpsKit 集成**
- 使用 `get_interactive()` 创建交互式日志器
- 利用 `storage` 模块进行配置持久化  
- 通过 `get_env_var()` 获取环境配置
- 集成 OpsKit 的交互式组件系统

### 测试方法

**1. 基本功能测试**
```bash
# 运行工具
opskit run s3-sync

# 测试连接
# 1. 选择创建新连接
# 2. 输入测试凭证
# 3. 验证存储桶列表显示
```

**2. 同步测试**
```bash
# 准备测试数据
# 1. 在源环境创建测试存储桶
# 2. 上传几个小文件
# 3. 运行同步测试
# 4. 验证目标环境文件一致性
```

**3. 错误处理测试**  
```bash
# 测试网络中断恢复
# 测试无效凭证处理
# 测试权限不足场景
```

## 使用示例

### 典型同步场景

**场景1: AWS 到 AWS 同步**
```
源环境: AWS Production (us-east-1)
目标环境: AWS Staging (us-west-2) 
操作: 同步特定存储桶到备份环境
```

**场景2: AWS 到 MinIO 同步**
```
源环境: AWS S3
目标环境: 私有云 MinIO 服务
操作: 数据迁移到私有云存储
```

**场景3: 跨区域备份**
```
源环境: AWS us-east-1
目标环境: AWS ap-southeast-1
操作: 灾备数据同步
```

### 操作流程示例

1. **启动工具**
   ```bash
   opskit run s3-sync
   ```

2. **配置源连接**
   - 选择已保存连接或创建新连接
   - 输入 AWS 凭证或使用默认配置
   - 验证连接并列出存储桶

3. **选择同步存储桶**
   - 从列表中选择一个或多个存储桶
   - 支持范围选择和批量选择

4. **配置目标连接**
   - 配置目标环境连接信息
   - 验证目标环境访问权限

5. **确认并执行**
   - 查看同步配置摘要
   - 确认执行同步操作
   - 监控同步进度和结果

### 性能优化建议

**并发配置**
```bash
# 高带宽环境
MAX_WORKERS=20

# 低带宽或不稳定网络
MAX_WORKERS=5
MAX_RETRIES=10
```

**网络优化**
```bash
# 提高重试延迟以适应网络延迟
RETRY_DELAY=5

# 对于临时操作禁用连接缓存
CACHE_CONNECTIONS=false
```

## 注意事项

### 安全考虑
1. **凭证保护**: 临时文件中的凭证已进行 Base64 编码
2. **权限控制**: 确保使用的 AWS 凭证具有适当的 S3 权限
3. **网络安全**: 在不安全网络环境中谨慎使用自定义端点

### 性能考虑
1. **带宽限制**: 根据网络带宽调整并发线程数
2. **存储成本**: 跨区域传输可能产生额外费用
3. **文件数量**: 大量小文件的同步效率相对较低

### 操作限制
1. **目标存储桶**: 目前使用与源存储桶相同的名称
2. **覆盖策略**: 目标存储桶中同名文件将被覆盖
3. **删除策略**: 工具不会删除目标存储桶中的额外文件

## 故障排除

### 常见问题

**连接测试失败**
```
原因: AWS 凭证无效或网络问题
解决: 
1. 检查 Access Key 和 Secret Key 是否正确
2. 确认网络连接和端点 URL
3. 工具会自动尝试 STS 和 head_bucket 测试方法
```

**无法列出存储桶**
```
原因: 缺少 ListAllMyBuckets 权限（这是正常的）
解决: 
1. 工具会自动提供手动输入选项
2. 直接输入已知的存储桶名称
3. 确保对目标存储桶有适当的操作权限
```

**同步中断**  
```
原因: 网络不稳定或服务限流
解决: 增加重试次数和延迟，减少并发线程数
```

**存储桶创建失败**
```
原因: 目标环境权限不足或存储桶名称冲突
解决: 确认 CreateBucket 权限，检查存储桶命名规则
```

### 调试模式
设置日志级别为 DEBUG 以获取详细信息：
```bash
# 在 data/.env 中设置
OPSKIT_LOGGING_CONSOLE_LEVEL=DEBUG
```

## 版本历史

### v1.0.0 (当前版本)
- 基于 OpsKit 框架重构
- 集成交互式组件系统
- 支持连接配置缓存
- 优化错误处理和重试机制
- 提供完整的环境变量配置支持

## 开发计划
1. 支持增量同步（仅同步变更文件）
2. 添加文件过滤和排除功能  
3. 支持自定义目标存储桶命名
4. 实现同步进度持久化和断点续传
5. 添加同步任务计划和自动化功能